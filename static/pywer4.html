<!DOCTYPE html>
<html>
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link rel="stylesheet" href="pywer4.css">
</head>

<body>


<h1>Puissance 4</h1>


<form onsubmit="return false">
    <table class="settings">
        <tr>
            <td><label for="nblines">Lignes:</label></td>
            <td><input type="text" id="nblines" name="nblines" size=2></td>
        </tr>
        <tr>
            <td><label for="nbcols">Colonnes:</label></td>
            <td><input type="text" id="nbcols" name="nbcols" size=2></td>
        </tr>
        <tr>
            <td><label for="level">Difficulté:</label></td>
            <td><input type="text" id="level" name="level" size=2></td>
        <tr>
        </tr>
        <td colspan="2"><input type="submit" value="Nouvelle Partie" id="start"></td>
        </tr>
    </table>
</form>

<br/>

<table id="mytable" class="grid"></table>

<p id=message></p>

<script>

    let level = 3
    let nblines = 6
    let nbcols = 7
    let grid_lock = false

    $("#nblines").val(nblines)
    $("#nbcols").val(nbcols)
    $("#level").val(level)


    function refresh_table() {
        grid_lock = true
        $("#mytable").empty()
        let i, j
        for (j = nblines; j >= 1; j--) {
            $("#mytable").append(`<tr id='l${j}'></tr>`)

            for (i = 1; i <= nbcols; i++) {
                $("#l" + j).append(`<td class='cell' line=${j} col=${i}></td>`)

            }

        }
        cell_click()
        grid_lock = false
        $("#message").html("Bonne chance !");
    }


    refresh_table()
    $("#message").html("Bienvenue");


    $("form").submit(function () {
            nblines = Number($("#nblines").val())
            nbcols = Number($("#nbcols").val())
            level = Number($("#level").val())
            refresh_table()

        }
    )

    function cell_click() {

        $(".cell").click(
            function () {
                if (grid_lock == false) {
                    grid_lock = true
                    var clicked_cell = $(this)

                    // list user tokens
                    const user_tokens = []
                    $(".cell[player=user]").each(
                        function () {
                            const coord = [Number($(this).attr("line")), Number($(this).attr("col"))]
                            user_tokens.push(coord)
                        }
                    )
                    //console.log(user_tokens)

                    // list computer tokens
                    const computer_tokens = []
                    $(".cell[player=computer]").each(
                        function () {
                            const coord = [Number($(this).attr("line")), Number($(this).attr("col"))]
                            computer_tokens.push(coord)
                        }
                    )

                    // build inputs for remote call
                    var state = {
                        "nblines": nblines,
                        "nbcols": nbcols,
                        "level": level,
                        "user_tokens": user_tokens,
                        "computer_tokens": computer_tokens
                    }
    
                    var user_input = {
                        "state": state,
                        "user_move": [Number(clicked_cell.attr("line")), Number(clicked_cell.attr("col"))]
                    }

                    // remote call to check user move
                    //console.log(user_input)
                    user_input_json = JSON.stringify(user_input)
                    //console.log(user_input_json)
                    $.post("/user_play",
                        {parameter: user_input_json},
                        function (data, status) {
                            //console.log(data)

                            // Valid user move
                            if (!data["valid_move"]) {
                                grid_lock = false
                            } else {
                                clicked_cell.attr("player", "user")

                                //alert("Data: " + data + "\nStatus: " + status);

                                state["user_tokens"].push(user_input["user_move"])
                                if (data["user_win"]) {
                                    $("#message").html("<p win='user'>Bravo !</p>")

                                    data["squares"].forEach(
                                        function (elt) {
                                            l = elt[0]
                                            c = elt[1]
                                            $(`.cell[line=${l}][col=${c}]`).attr("win", "user")
                                        }
                                    )
                                } else if (data["full"]) {
                                    $("#message").html("Égalité !")
                                } else {
                                    // remote call to get computer move
                                    state_json = JSON.stringify(state)
                                    $("#message").html("une seconde : l'ordinateur réfléchit");
                                    $.post("/computer_play",
                                        {parameter: state_json},
                                        function (data, status) {
                                            //console.log(data)
                                            l = data["move"][0]
                                            c = data["move"][1]
                                            $(`.cell[line=${l}][col=${c}]`).attr("player", "computer")
                                            if ((data["computer_win"] == false) && (data["full"] == false)) {
                                                grid_lock = false
                                                $("#message").html("A toi de jouer !");
                                            } else if (data["computer_win"]) {
                                                $("#message").html("<p win='computer'>Looser !</p>")
                                                data["squares"].forEach(
                                                    function (elt) {
                                                        l = elt[0]
                                                        c = elt[1]
                                                        $(`.cell[line=${l}][col=${c}]`).attr("win", "computer")
                                                    }
                                                )
                                            } else {
                                                $("#message").html("Égalité !")
                                            }
                                            //alert("Data: " + data + "\nStatus: " + status);
                                        }
                                    )
                                }
                            }
                        }
                    )

                }
            }
        )
    }

</script>


</body>
</html>